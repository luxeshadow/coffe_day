import{_ as x}from"./D-mM1yGB.js";import{B as h,K as U,D as M,r as f,j as S,e as k,v as V,x as $,f as A,c as G,a as r,b as B,d as u,t as W,E as P,G as y,H as C,I as N,z as E,w as R,o as q}from"#entry";import{_ as F}from"./DlAUqK2U.js";const c={createWithdrawl:async e=>{const{$supabase:t}=h(),{data:{user:s},error:o}=await t.auth.getUser();if(o||!s)throw new Error("Utilisateur non authentifié");const n=s.id,{data:w,error:d}=await t.from("wallets").select("*").eq("id_user",n).single();if(d||!w)throw new Error("Vous devez d’abord créer un wallet");if(w.password!==e.password)throw new Error("Mot de passe du wallet incorrect");const i=await U.getUserGains();if(e.amount>i.walletBalance)throw new Error("Montant supérieur au solde disponible");const{data:l,error:p}=await t.from("assigne_user_grade").select("id_grade, grades(daily_income)").eq("id_user",n);if(p||!l||l.length===0)throw new Error("Aucun grade assigné à l’utilisateur");const a=l.reduce((b,_)=>_.grades.daily_income>b.grades.daily_income?_:b,l[0]),g=Number(a.grades.daily_income)*10;if(e.amount<g)throw new Error(`Le montant minimum pour un retrait est de ${g}`);const{data:m,error:v}=await t.from("withdrawls").insert([{id_user:n,amount:e.amount,status:"En cours..."}]).select().single();if(v)throw v;return m},getUserWithdrawls:async()=>{const{$supabase:e}=h(),{data:{user:t},error:s}=await e.auth.getUser();if(s||!t)throw new Error("Utilisateur non authentifié");const{data:o,error:n}=await e.from("withdrawls").select("*").eq("id_user",t.id).order("id",{ascending:!1});if(n)throw n;return o},getWithdrawlsPaid:async()=>(await c.getUserWithdrawls()).filter(t=>t.status==="payed"),getWithdrawlsPending:async()=>(await c.getUserWithdrawls()).filter(t=>t.status==="pending"),getAllWithdrawls:async()=>{const{$supabase:e}=h(),{data:t,error:s}=await e.from("withdrawls").select("*").order("id",{ascending:!1});if(s)throw s;return t}};class L{async createWithdrawl(t){return c.createWithdrawl({amount:t.montant,password:t.password})}async getUserWithdrawls(){return c.getUserWithdrawls()}async getWithdrawlsPaid(){return c.getWithdrawlsPaid()}async getWithdrawlsPending(){return c.getWithdrawlsPending()}async getAllWithdrawls(){return c.getAllWithdrawls()}}const I=new L,z=e=>{const t=M(),s={},o=(t.dailyIncome??0)*10||0;return e.montant<o&&(s.montant=`Le montant minimum de retrait pour votre grade est de ${o} XOF`),(!e.password||e.password.length<4)&&(s.password="Le mot de passe doit contenir au moins 4 caractères"),s};function O(){const e=f(!1),t=f(null),s=f(null),o=S(),n=h().$toast;return{loading:e,error:t,withdrawl:s,createWithdrawl:async d=>{e.value=!0,t.value=null;try{z(d);const i=await I.createWithdrawl({montant:d.montant,password:d.password});return s.value=i,n({text:`Votre demande de retrait de ${d.montant.toLocaleString("fr-FR")} XOF est en cours ✅`,backgroundColor:"linear-gradient(to right, #00b09b, #96c93d)"}),o.push("/profile"),i}catch(i){console.error("Erreur création retrait :",i);const l=i.response?.data?.detail||i.message||"Erreur inconnue";return t.value=l,n({text:l,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}),null}finally{e.value=!1}}}}const T={class:"retrait-page"},X={class:"retrait-container"},j={class:"retrait-balance-info"},H={class:"retrait-balance-amount"},K={class:"retrait-form-group"},J={class:"retrait-form-group"},Q=["type"],Y=["disabled"],Z=k({__name:"retrait",setup(e){const t=V(),{createWithdrawl:s,loading:o}=O(),n=f({montant:null,password:""}),w=f(!1),d=$(()=>t.walletBalance);A(()=>{t.fetchUserGains()});const i=p=>`${Math.floor(p)} XOF`,l=async()=>{await s({montant:n.value.montant,password:n.value.password})};return(p,a)=>{const g=x;return q(),G("div",T,[r("div",X,[a[8]||(a[8]=r("div",{class:"retrait-header"},[r("h2",{class:"retrait-title"},[r("i",{class:"fas fa-wallet"}),u(" Formulaire de Retrait ")]),r("p",{class:"retrait-subtitle"},"Retirez vos gains en toute sécurité")],-1)),r("div",j,[a[2]||(a[2]=r("div",{class:"retrait-balance-label"},[r("i",{class:"fi fi-rr-send-money"}),u(" Solde disponible ")],-1)),r("div",H,W(i(d.value)),1)]),r("form",{class:"retrait-form",onSubmit:P(l,["prevent"])},[r("div",K,[a[3]||(a[3]=r("label",{for:"montant",class:"retrait-label"},[r("i",{class:"fi fi-rr-coins"}),u(" Montant à retirer ")],-1)),y(r("input",{type:"number",id:"montant","onUpdate:modelValue":a[0]||(a[0]=m=>n.value.montant=m),class:"retrait-input",required:"",placeholder:"Minimum En fonction du grade"},null,512),[[C,n.value.montant]]),a[4]||(a[4]=r("div",{class:"retrait-note"},[r("i",{class:"fi fi-rr-info"}),u(" Montant minimum : En fonction du grade ")],-1))]),r("div",J,[a[5]||(a[5]=r("label",{for:"password",class:"retrait-label"},[r("i",{class:"fi fi-rr-lock"}),u(" Mot de passe ")],-1)),y(r("input",{type:w.value?"text":"password",id:"password","onUpdate:modelValue":a[1]||(a[1]=m=>n.value.password=m),class:"retrait-input",required:"",placeholder:"Votre mot de passe"},null,8,Q),[[N,n.value.password]])]),r("button",{type:"submit",class:"retrait-submit-btn",disabled:E(o)},[a[6]||(a[6]=r("i",{class:"fas fa-check-circle"},null,-1)),u(" "+W(E(o)?"Traitement en cours...":"Valider le retrait"),1)],8,Y)],32),B(g,{to:"/profile",class:"retrait-back-link"},{default:R(()=>[...a[7]||(a[7]=[r("i",{class:"fas fa-arrow-left"},null,-1),u(" Retour au profil ",-1)])]),_:1})])])}}}),et=F(Z,[["__scopeId","data-v-2bc67f7b"]]);export{et as default};
