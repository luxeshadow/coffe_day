import{_ as k}from"./D-mM1yGB.js";import{B as h,M as m,r as p,e as x,N as T,c as P,a as r,b as M,E as C,G as f,d,H as g,n as y,z as w,t as S,w as N,o as z}from"#entry";import{_ as U}from"./DlAUqK2U.js";const v={createRecharge:async t=>{const{$supabase:n}=h(),{data:{user:o},error:a}=await n.auth.getUser();if(a||!o)throw new Error("Utilisateur non authentifié");const s=o.id,{data:i,error:c}=await n.from("recharges").select("id").eq("id_user",s);if(c)throw c;if((!i||i.length===0)&&t.amount<1e4)throw new Error("Le premier dépôt ne peut pas être inférieur à 10 000 XOF.");const{data:e,error:l}=await n.from("recharges").insert([{id_user:s,amount:t.amount,phone:t.phone,methode:t.methode??null,reference:t.reference??null,identifier:t.identifier??null}]).select().single();if(l)throw l;return e},getUserRecharges:async()=>{const{$supabase:t}=h(),{data:{user:n},error:o}=await t.auth.getUser();if(o||!n)throw new Error("Utilisateur non authentifié");const a=n.id,{data:s,error:i}=await t.from("recharges").select("*").eq("id_user",a).order("id",{ascending:!1});if(i)throw i;return s}},O={createRecharge:async t=>v.createRecharge(t),getUserRecharges:async()=>v.getUserRecharges()},G=t=>{if(!t.phone||t.phone.trim().length<8)throw new Error("Le numéro de téléphone est invalide (minimum 8 chiffres).");if(!t.amount||t.amount<1)throw new Error("Le montant minimum est de 1 XOF.");if(!t.methode||!["tmoney","flooz"].includes(t.methode))throw new Error("Veuillez sélectionner une méthode de paiement valide (TMoney ou Flooz).");return!0},E={async createPayment(t){const o=m().public.PAYGATE_KEY,a=await fetch("https://paygateglobal.com/api/v1/pay",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({auth_token:o,...t,network:t.network.toUpperCase()})});if(!a.ok)throw new Error(`Erreur PayGate: ${a.statusText}`);return await a.json()},async checkPaymentStatus(t){const o=m().public.PAYGATE_KEY,a=await fetch("https://paygateglobal.com/api/v1/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({auth_token:o,tx_reference:t})});if(!a.ok)throw new Error(`Erreur vérification PayGate: ${a.statusText}`);return await a.json()}};function V(){const t=p(!1),n=p(null),{$toast:o}=h();return{loading:t,error:n,createRecharge:async({phone:s,amount:i,paymentMethod:c})=>{t.value=!0,n.value=null;try{G({phone:s,amount:i,methode:c});const e=`TX-${Date.now()}`,l=await E.createPayment({phone_number:s,amount:i,network:c==="flooz"?"FLOOZ":"TMONEY",description:"Recharge de compte",identifier:e});if(console.log("TX_REFERENCE PayGate:",l.tx_reference),!l.tx_reference)throw new Error("tx_reference non reçu de PayGate");await new Promise(R=>setTimeout(R,3e4));const u=await E.checkPaymentStatus(String(l.tx_reference));if(console.log("Statut du paiement:",u),u.status!==0)throw new Error(u.message||"Échec du paiement PayGate");const b={phone:s,amount:i,methode:c,identifier:e,reference:l.tx_reference},_=await O.createRecharge(b);return o({text:"Recharge initiée avec succès !",backgroundColor:"linear-gradient(to right, #00b09b, #96c93d)"}),_}catch(e){throw console.error("Erreur recharge :",e),n.value=e.message||"Erreur inconnue",o({text:"Erreur : "+(e.message||"Erreur inconnue"),backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}),e}finally{t.value=!1}}}}const $={class:"recharge-page"},F={class:"recharge-container"},q={class:"recharge-form-group"},A={class:"recharge-form-group"},L={class:"recharge-payment-methods"},Y={class:"recharge-payment-options"},j=["disabled"],B=x({__name:"recharge",setup(t){const{loading:n,createRecharge:o}=V(),a=T({phone:"",amount:1,paymentMethod:"tmoney"});function s(c){a.paymentMethod=c}async function i(){try{await o({phone:a.phone,amount:a.amount,paymentMethod:a.paymentMethod})}catch(c){console.error("Erreur recharge:",c)}}return(c,e)=>{const l=k;return z(),P("div",$,[r("div",F,[e[11]||(e[11]=r("div",{class:"recharge-header"},[r("h2",{class:"recharge-title"},"Formulaire de Recharge"),r("p",{class:"recharge-subtitle"}," Rechargez votre compte en quelques étapes simples ")],-1)),r("form",{class:"recharge-form",onSubmit:C(i,["prevent"])},[r("div",q,[e[4]||(e[4]=r("label",{for:"telephone",class:"recharge-label"},[r("i",{class:"fi fi-rr-mobile-notch"}),d(" Numéro de téléphone ")],-1)),f(r("input",{type:"tel",id:"telephone","onUpdate:modelValue":e[0]||(e[0]=u=>a.phone=u),class:"recharge-input",required:"",pattern:"[0-9]{8,15}",placeholder:"Ex: 98765432"},null,512),[[g,a.phone]])]),r("div",A,[e[5]||(e[5]=r("label",{for:"montant",class:"recharge-label"},[r("i",{class:"fi fi-rr-send-money"}),d(" Montant à recharger ")],-1)),f(r("input",{type:"number",id:"montant","onUpdate:modelValue":e[1]||(e[1]=u=>a.amount=u),class:"recharge-input",min:"1",required:"",placeholder:"Entré montant à recharger"},null,512),[[g,a.amount]])]),r("div",L,[e[8]||(e[8]=r("h3",{class:"recharge-payment-title"},[r("i",{class:"fas fa-wallet"}),d(" Méthode de paiement ")],-1)),r("div",Y,[r("div",{class:y(["recharge-payment-option",{active:a.paymentMethod==="tmoney"}]),onClick:e[2]||(e[2]=u=>s("tmoney"))},[...e[6]||(e[6]=[r("i",{class:"fas fa-mobile-alt"},null,-1),r("span",null,"TMoney",-1)])],2),r("div",{class:y(["recharge-payment-option",{active:a.paymentMethod==="flooz"}]),onClick:e[3]||(e[3]=u=>s("flooz"))},[...e[7]||(e[7]=[r("i",{class:"fas fa-sim-card"},null,-1),r("span",null,"Flooz",-1)])],2)])]),r("button",{type:"submit",class:"recharge-submit-btn",disabled:w(n)},[e[9]||(e[9]=r("i",{class:"fas fa-check-circle"},null,-1)),d(" "+S(w(n)?"Traitement en cours...":"Valider la recharge"),1)],8,j)],32),M(l,{to:"/profile",class:"recharge-back-link"},{default:N(()=>[...e[10]||(e[10]=[r("i",{class:"fas fa-arrow-left"},null,-1),d("Retour au profil ",-1)])]),_:1})])])}}}),J=U(B,[["__scopeId","data-v-0df45458"]]);export{J as default};
