import{_ as b}from"./D-mM1yGB.js";import{r as l,A as k,B as E,C as S,e as C,v as U,D as N,j as V,c as h,o as w,a as s,y as _,E as A,G as x,H as G,I as L,n as I,z as y,d as g,t as q,b as B,w as D}from"#entry";import{l as P}from"./DYCMpitl.js";import{a as M}from"./DCzUsGh8.js";import{_ as $}from"./DlAUqK2U.js";function z(){const d=l(!1),r=l(null),a=l(null),f=k(),i=E().$toast,m=S();return{loading:d,error:r,user:a,loginUser:async u=>{d.value=!0,r.value=null;try{P(u);const o=await M.login(u.phone,u.password);if(!o.session)throw new Error("Échec de la connexion.");const n=o.session.access_token,t=o.user||o.session.user;m.setAuth({user_name:t.user_name||t.email,token:n,phone:t.user_metadata?.phone||""}),a.value=t,i({text:"Connexion réussie !",backgroundColor:"linear-gradient(to right, #00b09b, #96c93d)"}),console.log("Attempting to navigate to /home");try{await f.push("/home"),console.log("Navigation to /home successful")}catch(e){throw console.error("Navigation error:",e),new Error("Failed to navigate to /home")}return t}catch(o){console.error("Erreur login :",o);let n="Erreur inconnue";return o.message?.includes("Invalid login")?n="Numéro de téléphone ou mot de passe incorrect.":o.message&&(n=o.message),r.value=n,i({text:n,backgroundColor:"linear-gradient(to right, #ff5f6d, #ffc371)"}),null}finally{d.value=!1}}}}const R={class:"login-wrapper"},T={class:"login-container"},j={class:"form-group"},F={class:"form-group password-group"},H={class:"password-wrapper"},J=["type"],K=["disabled"],O={key:0,class:"fas fa-spinner fa-spin mr-2"},Q={class:"login-link"},W={key:0,class:"loading-overlay"},X=C({__name:"index",setup(d){const r=l({phone:"",password:""}),a=l(!1),{loginUser:f,loading:i}=z(),m=U(),c=N(),u=V(),o=l(!1),n=async()=>{try{const t={phone:r.value.phone,password:r.value.password},e=await f(t);if(e){console.log("✅ Utilisateur connecté :",e),o.value=!0;try{await Promise.all([m.fetchUserGains(),c.fetchGrades(),c.fetchUserGrades(),c.fetchUserDailyIncome()])}catch(v){console.error("Erreur lors du chargement des données utilisateur:",v)}finally{o.value=!1}u.push("/home")}}catch(t){console.error("Erreur login:",t)}};return(t,e)=>{const v=b;return w(),h("div",R,[s("div",T,[e[8]||(e[8]=s("h1",null,"Log in",-1)),e[9]||(e[9]=s("p",null,"Access your account to continue supporting a greener future!",-1)),s("form",{onSubmit:A(n,["prevent"]),id:"login-form"},[s("div",j,[e[3]||(e[3]=s("label",{for:"phone"},"Phone",-1)),x(s("input",{type:"text",id:"phone","onUpdate:modelValue":e[0]||(e[0]=p=>r.value.phone=p),placeholder:"Enter your phone number",required:"","aria-required":"true"},null,512),[[G,r.value.phone]])]),s("div",F,[e[4]||(e[4]=s("label",{for:"password"},"Password",-1)),s("div",H,[x(s("input",{type:a.value?"text":"password",id:"password","onUpdate:modelValue":e[1]||(e[1]=p=>r.value.password=p),placeholder:"Enter your password",required:"","aria-required":"true"},null,8,J),[[L,r.value.password]]),s("i",{class:I([a.value?"fi fi-rr-eye":"fi fi-rr-eye-crossed","toggle-password"]),onClick:e[2]||(e[2]=p=>a.value=!a.value)},null,2)])]),s("button",{type:"submit",disabled:y(i)||o.value},[y(i)||o.value?(w(),h("i",O)):_("",!0),g(" "+q(y(i)||o.value?"Logging in...":"Log in"),1)],8,K)],32),s("p",Q,[e[6]||(e[6]=g(" Don't have an account? ",-1)),B(v,{to:"/register"},{default:D(()=>[...e[5]||(e[5]=[g("Sign up",-1)])]),_:1}),e[7]||(e[7]=g(". ",-1))])]),o.value?(w(),h("div",W,[...e[10]||(e[10]=[s("div",{class:"spinner"},null,-1),s("p",null,"Chargement de vos données...",-1)])])):_("",!0)])}}}),re=$(X,[["__scopeId","data-v-cecd7c8c"]]);export{re as default};
